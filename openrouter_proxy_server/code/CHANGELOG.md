# CHANGELOG

## Версия 0.1.1 - 2025-05-20 07:53:56 (UTC+0)
### Changed
- Расширена обработка ошибок API: теперь ключи помечаются как нерабочие и происходит ротация при ошибках 401 (Unauthorized) и 5xx (Internal Server Error), в дополнение к существующей обработке 402 и 429.



Все заметные изменения в этом проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]
### Added
- **Обработка ошибки 404 (Not Found):** Добавлена логика пометки ключа как нерабочего и повторной попытки с другим ключом при получении ошибки 404 от OpenRouter API.
- **Новый эндпоинт `/v1/models`:** Добавлен GET-эндпоинт для получения списка доступных моделей с OpenRouter, отфильтрованных для отображения только бесплатных моделей (ID заканчивается на `:free`).
- **Обработка ошибок 500 (Internal Server Error):**
    - Добавлена логика повторной попытки с тем же ключом при получении ошибки 500 (до 3 попыток)
    - После 3 неудачных попыток ключ помечается как нерабочий с длительной задержкой восстановления
    - Добавлено логирование ошибок 500 в потоке
- **Обработка ошибок 429 (Quota Exceeded):**
    - Добавлено обнаружение ошибки 429 (превышение квоты) как в начальном ответе API, так и *внутри* потокового ответа (SSE).
    - Реализована временная блокировка ключа на 24 часа при получении ошибки 429 с использованием поля `recovery_timestamp` в `ApiKey` (`utils_proxy_open/key_manager.py`).
    - Добавлено автоматическое повторение запроса с другим ключом при возникновении ошибки 429 (без возврата ошибки конечному пользователю) (`utils_proxy_open/proxy_handler.py`).
- Реализована синхронизация ключей API с Google Sheets через экспорт CSV.
- Добавлены тесты для синхронизации с Google Sheets (`tests/test_gsheet_sync.py`).
- Добавлены тесты для оптимизированного чтения логов (`tests/test_logger.py`).
- Добавлены тесты для интерактивного меню (`tests/test_menu.py`).
- Добавлен файл `CHANGELOG.md` для отслеживания изменений.

### Changed
- **Обработка ошибок 429:** Логика выбора случайного ключа (`get_random_key`) и восстановления невалидных ключей (`recover_bad_keys`) теперь учитывает `recovery_timestamp` (`utils_proxy_open/key_manager.py`).
- **Логирование**: Файл логов (`proxy.log`) теперь очищается при каждом запуске сервера (`utils_proxy_open/logger_setup.py`).
- **Логирование**: Ответы от API (потоковые и полные) теперь логируются на уровне DEBUG для детальной отладки (`utils_proxy_open/proxy_handler.py`).
- **Логирование**: Добавлено логирование фрагментов ответа, отправляемых пользователю в потоковом режиме, с маркером `[OTVET_USER'U]...[/OTVET_USER'U]` на уровне DEBUG (`utils_proxy_open/proxy_handler.py`).
- **Логирование**: Добавлено логирование события остановки сервера через CTRL+C в консоли с маркером `[EXIT] Admin press CTRL+C in cosole [/EXIT]` на уровне WARNING (`utils_proxy_open/menu.py`).
- **Логирование**: Добавлены миллисекунды в формат временных меток (`utils_proxy_open/logger_setup.py`).
- **Логирование**: Значительно расширена детализация логов в `proxy_handler.py` для лучшей отладки цикла retry и процесса буферизации потока (логируются причины ретраев, начало/конец буферизации, финальный статус).
- Доработано интерактивное меню (`menu.py`) для полной интеграции с FastAPI (`app.state`) и асинхронным выполнением.
- Оптимизировано чтение последних строк лог-файла в `logger_setup.get_last_logs` с использованием `aiofiles`.
- **Обработка ошибок 429 (в потоке):** Реализован **наиболее надежный** механизм retry. При возникновении ошибки 429 *внутри* потока, сервер теперь **внутренне буферизует** весь успешный поток перед отправкой клиенту. Если во время буферизации возникает ошибка 429, **весь запрос пользователя полностью перезапускается** с новым ключом API. Это гарантирует доставку полного ответа, но может увеличить задержку для пользователя, так как "настоящий" стриминг происходит только после успешной буферизации (`utils_proxy_open/proxy_handler.py`).
- Улучшена обработка поля `ApiKey.counter_or_error` для большей ясности и типобезопасности. Возможно, разделено на `counter` и `error`.
- Обновлен `Readme.md` для отражения новых функций и изменений.

### Changed
- **Рефакторинг обработки потоков и ошибок 429:** Значительно переработана логика в `handle_proxy_chat_completions` и `_process_api_response` для корректной обработки исключения `QuotaExceededInStreamError` (ошибка 429 внутри потока). Теперь потребление потока происходит внутри основного цикла `try...except`, что позволяет правильно перехватывать ошибку и запускать механизм повторных попыток (`utils_proxy_open/proxy_handler.py`).
- **Обработка ошибок 429:** Логика выбора случайного ключа (`get_random_key`) и восстановления невалидных ключей (`recover_bad_keys`) теперь учитывает `recovery_timestamp` (`utils_proxy_open/key_manager.py`).
- **Логирование**: Файл логов (`proxy.log`) теперь очищается при каждом запуске сервера (`utils_proxy_open/logger_setup.py`).
- **Логирование**: Ответы от API (потоковые и полные) теперь логируются на уровне DEBUG для детальной отладки (`utils_proxy_open/proxy_handler.py`).
- Доработано интерактивное меню (`menu.py`) для полной интеграции с FastAPI (`app.state`) и асинхронным выполнением.
- Оптимизировано чтение последних строк лог-файла в `logger_setup.get_last_logs` с использованием `aiofiles`.
- Упрощена и рефакторизована логика обработки запросов и повторных попыток в `proxy_handler.py`.
- Улучшена обработка поля `ApiKey.counter_or_error` для большей ясности и типобезопасности. Возможно, разделено на `counter` и `error`.
- Обновлен `Readme.md` для отражения новых функций и изменений.
- **Рефакторинг `proxy_handler.py`:** Логика буферизации потока и обработки ошибок в нем вынесена из `handle_proxy_chat_completions` в отдельную вспомогательную функцию `_handle_buffered_stream` для улучшения читаемости.
- **Диагностика:** Добавлено более подробное логирование в `config_manager.py` и `logger_setup.py` для облегчения диагностики проблем с чтением `config.ini` и созданием лог-файла.
- **Механизм сохранения статуса ключей:** Уточнено в `Readme.md` и коде (`proxy_handler.py`), что статус ключа ('good'/'bad') сохраняется в `keys.csv` немедленно (`save_now=True`) при большинстве критических ошибок (4xx, 50x, таймауты, ошибки в потоке) и после успешных запросов, а не только при завершении работы или по таймеру.
- **Отложенная пометка ключей 'bad' (402/429):**
    - Реализован механизм отложенной пометки ключей как 'bad' при ошибках 402 (Payment Required) и 429 (Too Many Requests).
    - Ключ помечается как 'bad' только *после* того, как запрос успешно выполнен с *другим* ключом.
    - Все изменения статусов (успешного и неудавшихся ключей) сохраняются в `keys.csv` одним действием после успешного запроса.
- **Формат `keys.csv`:** Добавлен новый столбец `marked_bad_at` для хранения времени (YYYY-MM-DD HH:MM:SS), когда ключ был помечен как 'bad'. Формат теперь: `key;status;usage_count_or_error_msg;marked_bad_at`.

### Fixed
- **Получение ключа API:** Исправлена ошибка `AttributeError: 'KeyManager' object has no attribute 'get_key'` в `utils_proxy_open/proxy_handler.py` путем замены вызова `km_instance.get_key()` на правильный метод `km_instance.get_random_key()`.
- **Эндпоинт `/chat/completions`:** Исправлена ошибка 404 Not Found путем добавления недостающего обработчика POST-запросов для `/chat/completions` в `utils_proxy_open/proxy_handler.py`.
- **Запуск приложения:** Исправлена ошибка `ImportError: cannot import name 'setup_proxy_routes'` в `main.py` путем добавления недостающей функции `setup_proxy_routes` в `utils_proxy_open/proxy_handler.py`.
- **Обработка ошибок 500:**
    - Исправлены синтаксические ошибки в proxy_handler.py
    - Добавлены недостающие блоки обработки исключений
    - Исправлена опечатка в response.clored -> response.closed
- **Обработка ошибок 429 (в потоке):** Реализована обработка `QuotaExceededInStreamError` внутри цикла `while` в `handle_proxy_chat_completions` с использованием внутренней буферизации потока для обеспечения полного перезапуска запроса при ошибке (`utils_proxy_open/proxy_handler.py`).
- **Обработка ошибок 429 (в потоке):** Исправлена ошибка в `_stream_response_generator`, из-за которой ошибка 429 внутри потока не всегда распознавалась (проверялось не только `code: 429`, но и текст сообщения). Теперь проверка полагается только на код ошибки (`utils_proxy_open/proxy_handler.py`).
- **Интерактивное меню:** Исправлена ошибка `EOFError`, которая могла возникать при использовании `input()` в некоторых средах и приводить к аварийному завершению потока меню и всего сервера (`utils_proxy_open/menu.py`).
- **Логирование:** Исправлена ошибка `AttributeError: 'LoggerSetup' object has no attribute 'log'` в `_process_api_response`, которая приводила к падению при попытке логировать HTTP-ошибки и вызывала некорректные циклы retry (`utils_proxy_open/proxy_handler.py`).
- Исправлены потенциальные ошибки типов и логики в `key_manager.py` (статусы ключей, `counter_or_error`).
- Исправлены ошибки отступов в `proxy_handler.py` после предыдущих правок.
- Улучшена обработка исключений при чтении файлов конфигурации и ключей.
- Исправлены другие мелкие синтаксические и логические ошибки, выявленные при анализе.
- **Дублирование кода:** Удалено дублирующееся определение функции `_stream_response_generator` в `utils_proxy_open/proxy_handler.py`.
- **Формат `keys.csv`:** Восстановлена логика чтения/записи файла `keys.csv` для поддержки формата `ключ;статус;значение` (счетчик или сообщение об ошибке) согласно требованию пользователя. Статус и счетчик теперь снова сохраняются в файле.
- **Отступы:** Исправлены ошибки отступов в `utils_proxy_open/config_manager.py`, возникшие при предыдущем редактировании.

### Removed
- Удалены закомментированные тесты для Google Sheets (`test_gsheet_sync_task`), так как реализована новая логика и тесты.
